name: OpenWrt Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target:
        description: 'OpenWrt target architecture (e.g., x86_64, arm_cortex-a9, mipsel_24kc)'
        required: false
        default: 'x86_64'
      sdk_version:
        description: 'OpenWrt SDK version (e.g., 23.05.0, 22.03.5)'
        required: false
        default: '24.10.2'

permissions:
  contents: write

jobs:
  build-openwrt:
    name: Build OpenWrt Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [x86_64, arm_cortex-a9, mipsel_24kc, aarch64_generic]
        sdk_version: [24.10.2]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build OpenWrt binaries
      run: |
        echo "üî® Building for OpenWrt ${{ matrix.sdk_version }} - ${{ matrix.target }}"
        
        # Create build directory
        mkdir -p build/openwrt-${{ matrix.sdk_version }}-${{ matrix.target }}
        
        # Create Dockerfile for this specific target
        cat > Dockerfile.openwrt << 'EOF'
        FROM ubuntu:22.04
        
        # Install dependencies
        RUN apt-get update && apt-get install -y \
            build-essential \
            wget \
            tar \
            xz-utils \
            ca-certificates \
            && rm -rf /var/lib/apt/lists/*
        
        # Set working directory
        WORKDIR /build
        
        # Download and extract OpenWrt SDK
        RUN wget -O openwrt-sdk.tar.xz \
            "https://downloads.openwrt.org/releases/${{ matrix.sdk_version }}/targets/${{ matrix.target }}/openwrt-sdk-${{ matrix.sdk_version }}-${{ matrix.target }}-gcc-12.3.0_musl.Linux-x86_64.tar.xz" \
            || echo "Failed to download SDK for ${{ matrix.target }} on ${{ matrix.sdk_version }}"
        
        # Extract SDK
        RUN tar -xf openwrt-sdk.tar.xz && \
            mv openwrt-sdk-* openwrt-sdk
        
        # Set environment variables
        ENV STAGING_DIR=/build/openwrt-sdk/staging_dir
        ENV TOOLCHAIN_DIR=/build/openwrt-sdk/staging_dir/toolchain-${{ matrix.target }}_gcc-12.3.0_musl
        ENV PATH=$TOOLCHAIN_DIR/bin:$PATH
        
        # Copy source code
        COPY . /build/source
        
        # Build the project
        WORKDIR /build/source
        
        # Create Makefile for OpenWrt
        RUN cat > Makefile.openwrt << 'MAKEFILE_EOF'
        # OpenWrt-specific Makefile
        CC=$(TOOLCHAIN_DIR)/bin/${{ matrix.target }}-openwrt-linux-musl-gcc
        CFLAGS=-Wall -Wextra -std=c99 -O2 -s
        LIBS=-lcurl
        LIBDIR=lib
        PROGRAMS=tools/getip tools/setip tools/publicip cloudflare_renew
        
        LIB_SOURCES=$(LIBDIR)/json.c $(LIBDIR)/cloudflare_utils.c $(LIBDIR)/http_utils.c $(LIBDIR)/publicip.c $(LIBDIR)/getip.c $(LIBDIR)/setip.c
        LIB_HEADERS=$(LIBDIR)/json.h $(LIBDIR)/cloudflare_utils.h $(LIBDIR)/http_utils.h $(LIBDIR)/publicip.h $(LIBDIR)/getip.h $(LIBDIR)/setip.h
        
        all: $(PROGRAMS)
        
        tools/getip: tools/getip.c $(LIB_SOURCES) $(LIB_HEADERS)
        	$(CC) $(CFLAGS) -o $@ tools/getip.c $(LIB_SOURCES) $(LIBS)
        
        tools/setip: tools/setip.c $(LIB_SOURCES) $(LIB_HEADERS)
        	$(CC) $(CFLAGS) -o $@ tools/setip.c $(LIB_SOURCES) $(LIBS)
        
        tools/publicip: tools/publicip.c $(LIB_SOURCES) $(LIB_HEADERS)
        	$(CC) $(CFLAGS) -o $@ tools/publicip.c $(LIB_SOURCES) $(LIBS)
        
        cloudflare_renew: cloudflare_renew.c $(LIB_SOURCES) $(LIB_HEADERS)
        	$(CC) $(CFLAGS) -o $@ cloudflare_renew.c $(LIB_SOURCES) $(LIBS)
        
        clean:
        	rm -f $(PROGRAMS)
        MAKEFILE_EOF
        
        # Build using OpenWrt toolchain
        RUN make -f Makefile.openwrt clean
        RUN make -f Makefile.openwrt all
        
        # Verify binaries
        RUN file tools/getip tools/setip tools/publicip cloudflare_renew
        
        # Create package
        RUN mkdir -p /build/package
        RUN cp tools/getip tools/setip tools/publicip cloudflare_renew /build/package/
        RUN cp cloudflare.conf.sample /build/package/
        RUN cp README.md LICENSE /build/package/
        RUN cp getip-all.sh setip-all.sh /build/package/
        
        # Create install script
        RUN cat > /build/package/install.sh << 'INSTALL_EOF'
        #!/bin/sh
        echo "üöÄ Cloudflare DNS Renew OpenWrt Setup"
        echo "====================================="
        
        # Make binaries executable
        chmod +x cloudflare_renew getip setip publicip getip-all.sh setip-all.sh
        
        # Check if config exists
        if [ ! -f cloudflare.conf ]; then
          echo "üìã Creating cloudflare.conf from template..."
          cp cloudflare.conf.sample cloudflare.conf
          echo "‚ö†Ô∏è  Please edit cloudflare.conf with your Zone ID, DNS Record ID, and Domain Name"
        fi
        
        # Check if token exists
        if [ ! -f cloudflare.token ]; then
          echo "üîë Please create cloudflare.token with your Cloudflare API token"
          echo "   Get your token from: https://dash.cloudflare.com/profile/api-tokens"
        fi
        
        echo ""
        echo "‚úÖ Setup complete! Available commands:"
        echo "   ./cloudflare_renew          - Automatic DNS management"
        echo "   ./getip <config> <token>    - Get current DNS IP"
        echo "   ./setip <config> <token> <ip> - Set DNS IP"
        echo "   ./publicip                  - Get public IP"
        echo ""
        echo "üìñ See README.md for detailed documentation"
        INSTALL_EOF
        
        RUN chmod +x /build/package/install.sh
        
        # Create tarball
        RUN cd /build && tar -czf cloudflare-renew-openwrt-${{ matrix.sdk_version }}-${{ matrix.target }}.tar.gz package/
        
        # Copy result to host
        RUN cp /build/cloudflare-renew-openwrt-${{ matrix.sdk_version }}-${{ matrix.target }}.tar.gz /build/source/build/openwrt-${{ matrix.sdk_version }}-${{ matrix.target }}/
        EOF
        
        # Build Docker image and run build
        docker build -f Dockerfile.openwrt -t openwrt-builder-${{ matrix.target }}-${{ matrix.sdk_version }} .
        
        # Clean up Docker image
        docker rmi openwrt-builder-${{ matrix.target }}-${{ matrix.sdk_version }}
        
        echo "‚úÖ Build completed for ${{ matrix.target }} on ${{ matrix.sdk_version }}"
        
    - name: Upload OpenWrt binaries
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-binaries-${{ matrix.sdk_version }}-${{ matrix.target }}
        path: build/openwrt-${{ matrix.sdk_version }}-${{ matrix.target }}/
        retention-days: 30
        
    - name: Create release assets
      if: github.ref == 'refs/heads/main'
      run: |
        echo "üì¶ Preparing OpenWrt release assets..."
        
        # Get version
        if [ -f VERSION ]; then
          VERSION="v$(cat VERSION)"
        else
          DATE=$(date +%Y.%m.%d)
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION="v${DATE}-${SHORT_SHA}"
        fi
        
        # Check if release exists
        if gh release view "$VERSION" >/dev/null 2>&1; then
          echo "üì§ Uploading OpenWrt binaries to existing release $VERSION"
          
          # Upload each OpenWrt binary package
          for pkg in build/openwrt-*/*.tar.gz; do
            if [ -f "$pkg" ]; then
              echo "üì§ Uploading $pkg..."
              gh release upload "$VERSION" "$pkg" --clobber
            fi
          done
        else
          echo "‚ö†Ô∏è  Release $VERSION does not exist yet. Run the release workflow first."
        fi
        
    - name: Build summary
      run: |
        echo "üèóÔ∏è  OpenWrt Build Summary"
        echo "========================="
        echo "Target: ${{ matrix.target }}"
        echo "SDK Version: ${{ matrix.sdk_version }}"
        echo "Build Status: ‚úÖ Success"
        echo ""
        echo "Built binaries:"
        ls -la build/openwrt-${{ matrix.sdk_version }}-${{ matrix.target }}/
        echo ""
        echo "Package:"
        ls -lh build/openwrt-${{ matrix.sdk_version }}-${{ matrix.target }}/*.tar.gz
