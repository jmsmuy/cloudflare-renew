FROM ubuntu:22.04

# Install dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    wget \
    tar \
    xz-utils \
    zstd \
    ca-certificates \
    libncurses5-dev \
    libncursesw5-dev \
    git \
    rsync \
    gawk \
    unzip \
    python3 \
    python3-distutils \
    python3-pip \
    file \
    swig \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /build

# Download and extract OpenWrt SDK
ARG SDK_URL
RUN wget -O openwrt-sdk.tar.zst "$SDK_URL" \
    || echo "Failed to download SDK"

# Extract SDK
RUN tar -xf openwrt-sdk.tar.zst && \
    mv openwrt-sdk-* openwrt-sdk

# Copy source code into container
COPY . /build/source

# Create package
RUN mkdir -p openwrt-sdk/package
RUN mkdir -p openwrt-sdk/package/cloudflare-renew
RUN mkdir -p openwrt-sdk/package/cloudflare-renew/src
RUN mkdir -p openwrt-sdk/package/cloudflare-renew/src/lib
RUN mkdir -p openwrt-sdk/package/cloudflare-renew/src/tools
RUN mkdir -p openwrt-sdk/package/cloudflare-renew/src/tests

RUN cp /build/source/cloudflare_renew.c /build/source/Makefile openwrt-sdk/package/cloudflare-renew/src/
RUN cp /build/source/lib/json.c /build/source/lib/json.h openwrt-sdk/package/cloudflare-renew/src/lib/
RUN cp /build/source/lib/cloudflare_utils.c /build/source/lib/cloudflare_utils.h openwrt-sdk/package/cloudflare-renew/src/lib/
RUN cp /build/source/lib/socket_http.c /build/source/lib/socket_http.h openwrt-sdk/package/cloudflare-renew/src/lib/
RUN cp /build/source/lib/publicip.c /build/source/lib/publicip.h openwrt-sdk/package/cloudflare-renew/src/lib/
RUN cp /build/source/lib/getip.c /build/source/lib/getip.h openwrt-sdk/package/cloudflare-renew/src/lib/
RUN cp /build/source/lib/setip.c /build/source/lib/setip.h openwrt-sdk/package/cloudflare-renew/src/lib/
RUN cp /build/source/lib/http_utils.c /build/source/lib/http_utils.h openwrt-sdk/package/cloudflare-renew/src/lib/
RUN cp /build/source/tools/getip.c openwrt-sdk/package/cloudflare-renew/src/tools/
RUN cp /build/source/tools/setip.c openwrt-sdk/package/cloudflare-renew/src/tools/
RUN cp /build/source/tools/publicip.c openwrt-sdk/package/cloudflare-renew/src/tools/

RUN cp /build/source/.config openwrt-sdk/.config
RUN cp /build/source/Makefile.openwrt openwrt-sdk/package/cloudflare-renew/Makefile

# Update and install feeds
RUN ./openwrt-sdk/scripts/feeds update cloudflare-renew
RUN ./openwrt-sdk/scripts/feeds install -a

# Build the package
RUN cd openwrt-sdk && make package/cloudflare-renew/compile V=s

# Copy the compiled package to a known location
RUN find openwrt-sdk/bin/packages -name "cloudflare-renew*.ipk" -exec cp {} /build/ \;

# Create tarball with the compiled package
RUN cd /build && tar -czf cloudflare-renew-openwrt-package.tar.gz *.ipk

# Copy result to host
RUN cp /build/cloudflare-renew-openwrt-package.tar.gz /build/source/build/
